<!--
Path: src/templates/index.html
Purpose: Single-page dashboard with Bootstrap tabs for:
  - Quick single prediction (Tab A)
  - Batch CSV upload + results (Tab B)

Notes / docstring:
- Uses the existing Flask endpoints:
    POST /predict         -> expects JSON or form; returns JSON { ok, result, ... }
    POST /predict_batch   -> expects multipart/form-data file upload; returns attachment
    GET  /api/explain_files -> returns JSON listing explain artifacts { ok, files, latest }
    GET  /reports/explain/<filename> -> serves explain assets from reports/explain
- Cache-busting: latest explain image / iframe loaded with ?t=<mtime> or Date.now()
- Testing recommendation:
    * Unit tests: backend endpoints (/predict, /predict_batch, /api/explain_files) using Flask test_client.
    * Integration tests: end-to-end flow uploading a tiny CSV and verifying returned predictions + that explain files list is produced.
    * Frontend: lightweight integration smoke test using Playwright / Selenium if desired to verify tab switching + form submits.
-->

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Diabetes Risk Prediction Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet">
  <script src="{{ url_for('static', filename='js/chart.min.js') }}"></script>
  <style>
    body { padding-top: 1.5rem; background: #f7f8fa; }
    .card { border-radius: 0.6rem; box-shadow: 0 6px 18px rgba(0,0,0,0.04); }
    .section-title { font-weight:600; }
    .small-muted { font-size:.9rem; color:#6c757d; }
  </style>
</head>
<body class="container">
  <h1 class="mb-4">Diabetes Risk Prediction Dashboard</h1>

  <ul class="nav nav-tabs mb-3" id="mainTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="single-tab" data-bs-toggle="tab" data-bs-target="#single" type="button" role="tab">Quick single prediction</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="batch-tab" data-bs-toggle="tab" data-bs-target="#batch" type="button" role="tab">Batch CSV upload</button>
    </li>
  </ul>

  <div class="tab-content">
    <!-- Single prediction tab -->
    <div class="tab-pane fade show active" id="single" role="tabpanel" aria-labelledby="single-tab">
      <div class="row">
        <div class="col-md-6">
          <div class="card p-3">
            <div class="section-title mb-2">Enter features</div>
            <form id="singleForm" method="post" novalidate>
              <div class="row g-2">
                <div class="col-6">
                  <label class="form-label">Pregnancies</label>
                  <input name="Pregnancies" class="form-control" type="number" value="0" required>
                </div>
                <div class="col-6">
                  <label class="form-label">Glucose</label>
                  <input name="Glucose" class="form-control" type="number" value="100" required>
                </div>
                <div class="col-6">
                  <label class="form-label">BloodPressure</label>
                  <input name="BloodPressure" class="form-control" type="number" value="70" required>
                </div>
                <div class="col-6">
                  <label class="form-label">SkinThickness</label>
                  <input name="SkinThickness" class="form-control" type="number" value="20" required>
                </div>
                <div class="col-6">
                  <label class="form-label">Insulin</label>
                  <input name="Insulin" class="form-control" type="number" value="85" required>
                </div>
                <div class="col-6">
                  <label class="form-label">BMI</label>
                  <input name="BMI" class="form-control" step="0.1" type="number" value="30.5" required>
                </div>
                <div class="col-6">
                  <label class="form-label">DiabetesPedigreeFunction</label>
                  <input name="DiabetesPedigreeFunction" class="form-control" step="0.001" type="number" value="0.5" required>
                </div>
                <div class="col-6">
                  <label class="form-label">Age</label>
                  <input name="Age" class="form-control" type="number" value="35" required>
                </div>
              </div>

              <div class="mt-3 d-grid">
                <button id="singleSubmit" class="btn btn-primary">Predict</button>
              </div>
            </form>
          </div>

          <div class="card mt-3 p-3" id="singleResultCard" style="display:none;">
            <div class="section-title">Result</div>
            <div id="singleUserMessage" class="mt-2"></div>
            <div class="mt-3">
              <canvas id="singleProbChart" width="300" height="120"></canvas>
            </div>
            <div class="mt-3">
              <div class="section-title">Explainability artifacts</div>
              <ul id="singleFilesList" class="list-unstyled small-muted"></ul>
            </div>
            <div class="mt-2 small-muted">This result is informational and not a medical diagnosis.</div>
          </div>
        </div>

        <div class="col-md-6">
          <div class="card p-3">
            <div class="section-title">Model info</div>
            <p class="small-muted mb-0">Model path: <strong id="modelPath">{{ model_path or "None found" }}</strong></p>
            <pre id="metricsBlock" class="mt-2 small-muted">{{ metrics | tojson(indent=2) }}</pre>
          </div>

          <div class="card mt-3 p-3">
            <div class="section-title">Latest explain files</div>
            <p class="small-muted">Click to open in new tab. Images and HTML are served from <code>reports/explain/</code>.</p>
            <ul id="explainList" class="list-unstyled small-muted"></ul>
          </div>
        </div>
      </div>
    </div>

    <!-- Batch prediction tab -->
    <div class="tab-pane fade" id="batch" role="tabpanel" aria-labelledby="batch-tab">
      <div class="row">
        <div class="col-md-6">
          <div class="card p-3">
            <div class="section-title mb-2">Upload CSV</div>
            <form id="batchForm" method="post" enctype="multipart/form-data" action="/predict_batch">
              <input id="batchFile" name="file" type="file" accept=".csv" class="form-control" required>
              <div class="mt-3 d-grid">
                <button class="btn btn-secondary">Upload & Predict</button>
              </div>
            </form>
            <div class="small-muted mt-2">CSV should contain the feature columns (Outcome column will be ignored if present).</div>
          </div>

          <div class="card mt-3 p-3" id="batchResultCard" style="display:none;">
            <div class="section-title">Batch summary</div>
            <div id="batchSummary" class="mt-2 small-muted"></div>
            <div class="mt-3">
              <canvas id="batchHist" width="300" height="140"></canvas>
            </div>
            <div class="mt-3">
              <div class="section-title">Generated artifacts</div>
              <ul id="batchFilesList" class="list-unstyled small-muted"></ul>
            </div>
          </div>
        </div>

        <div class="col-md-6">
          <div class="card p-3">
            <div class="section-title">Notes & guidance</div>
            <p class="small-muted">Batch predictions are processed server-side. We will drop any Outcome column included by the CSV to avoid mismatches with the model.</p>
            <p class="small-muted">Artifacts are saved under <code>reports/explain/</code> and listed here for inspection. No download button is provided — click files to view them.</p>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  // Utility to render explain file lists from server response
  async function refreshExplainList() {
    try {
      const res = await fetch('/api/explain_files');
      if (!res.ok) return;
      const payload = await res.json();
      if (!payload.ok) return;
      const list = payload.files || [];
      const el = document.getElementById('explainList');
      el.innerHTML = '';
      list.forEach(f => {
        const li = document.createElement('li');
        const a = document.createElement('a');
        a.href = `/reports/explain/${encodeURIComponent(f.filename)}?t=${f.mtime}`;
        a.target = '_blank';
        a.text = f.filename;
        li.appendChild(a);
        li.appendChild(document.createTextNode(` — ${new Date(f.mtime * 1000).toLocaleString()}`));
        el.appendChild(li);
      });
    } catch (e) { console.error(e); }
  }

  // Single form handling
  document.getElementById('singleForm').addEventListener('submit', async (ev) => {
    ev.preventDefault();
    const form = new FormData(ev.target);
    const payload = {};
    form.forEach((v,k) => payload[k] = Number(v) ? Number(v) : v);
    try {
      const res = await fetch('/predict', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload) });
      const json = await res.json();
      if (!json.ok) {
        alert('Prediction error: ' + (json.error || 'unknown'));
        return;
      }
      const r = json.result;
      // show friendly message
      const msgEl = document.getElementById('singleUserMessage');
      msgEl.innerHTML = `<strong>${r.user_message}</strong>`;
      // show explain files
      const fl = r.explanation_files || [];
      const list = document.getElementById('singleFilesList'); list.innerHTML='';
      fl.forEach(f => {
        const li = document.createElement('li');
        const a = document.createElement('a');
        a.href = `/reports/explain/${encodeURIComponent(f.filename)}?t=${f.mtime}`;
        a.target = '_blank';
        a.text = f.filename;
        li.appendChild(a);
        list.appendChild(li);
      });
      // render probability chart
      const pct = Math.round((r.probability||0) * 10000) / 100;
      const ctx = document.getElementById('singleProbChart').getContext('2d');
      if (window._singleChart) window._singleChart.destroy();
      window._singleChart = new Chart(ctx, {
        type: 'bar',
        data: { labels:['Risk (%)'], datasets:[{ label:'Probability (%)', data:[pct], borderWidth:1 }] },
        options: { indexAxis:'y', scales:{ x:{ beginAtZero:true, max:100 } } }
      });
      document.getElementById('singleResultCard').style.display='block';
      refreshExplainList();
    } catch (e) { alert('Request failed: '+e); console.error(e); }
  });

  // Batch form: submit normally (server will return JSON or redirect); we intercept and handle JSON response
  document.getElementById('batchForm').addEventListener('submit', async (ev) => {
    ev.preventDefault();
    const fileInput = document.getElementById('batchFile');
    if (!fileInput.files || !fileInput.files[0]) { alert('Please select a CSV file'); return; }
    const fd = new FormData();
    fd.append('file', fileInput.files[0]);
    try {
      const res = await fetch('/predict_batch', { method:'POST', body: fd });
      const json = await res.json();
      if (!json.ok) {
        alert('Batch error: ' + (json.error || 'unknown'));
        return;
      }
      const r = json.result;
      const summary = `Rows processed: ${r.n_rows}. Predicted positives: ${r.n_positive}. Average risk: ${(r.mean_probability*100).toFixed(2)}%.`;
      document.getElementById('batchSummary').textContent = summary;
      // histogram
      const ctx = document.getElementById('batchHist').getContext('2d');
      if (window._batchChart) window._batchChart.destroy();
      window._batchChart = new Chart(ctx, {
        type: 'bar',
        data: { labels: r.hist_bins, datasets: [{ label:'Count', data: r.hist_counts }] },
        options: {}
      });
      // show artifact list
      const list = document.getElementById('batchFilesList'); list.innerHTML='';
      (r.explanation_files || []).forEach(f=>{
        const li = document.createElement('li');
        const a = document.createElement('a');
        a.href = `/reports/explain/${encodeURIComponent(f.filename)}?t=${f.mtime}`;
        a.target = '_blank'; a.text = f.filename;
        li.appendChild(a);
        list.appendChild(li);
      });
      document.getElementById('batchResultCard').style.display='block';
      refreshExplainList();
    } catch (e) { alert('Batch request failed: '+e); console.error(e); }
  });

  // initial explain list
  refreshExplainList();
  setInterval(refreshExplainList, 30_000);
</script>

<!-- Bootstrap bundle (local or CDN fallback if missing) -->
<script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
</body>
</html>
