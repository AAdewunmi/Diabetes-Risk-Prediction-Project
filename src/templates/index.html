<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Diabetes Risk Prediction Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet">
  <script src="{{ url_for('static', filename='js/chart.min.js') }}"></script>
  <style>
    body { padding-top: 2rem; }
    .risk-card { padding: 1rem; border-radius: .5rem; box-shadow: 0 2px 6px rgba(0,0,0,0.06); }
  </style>
</head>
<body class="container">
  <h1 class="mb-4">Diabetes Risk Prediction Dashboard</h1>

  <div class="row">
    <div class="col-md-6">
      <div class="card risk-card">
        <h5>Quick single prediction</h5>
        <form id="singleForm" method="post" action="/predict">
          <div class="mb-2">
            <label class="form-label">Glucose</label>
            <input name="Glucose" class="form-control" required>
          </div>
          <div class="mb-2">
            <label class="form-label">BMI</label>
            <input name="BMI" class="form-control" required>
          </div>
          <div class="mb-2">
            <label class="form-label">Age</label>
            <input name="Age" class="form-control" required>
          </div>
          <button class="btn btn-primary" type="submit">Predict</button>
        </form>
        <div id="singleResult" class="mt-3" style="display:none;">
          <h6>Result</h6>
          <p id="resultText"></p>
        </div>
      </div>

      <div class="card mt-3 p-3">
        <h5>Batch CSV upload</h5>
        <form action="/predict_batch" method="post" enctype="multipart/form-data">
          <input type="file" name="file" accept=".csv" class="form-control mb-2">
          <button class="btn btn-secondary" type="submit">Upload & Predict</button>
        </form>
        <small class="text-muted">Upload a CSV with feature columns (Outcome column will be ignored).</small>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card p-3">
        <h5>Model Info</h5>
        <p>Model path: <strong id="modelPath">{{ model_path or "None found" }}</strong></p>
        <p>Metrics:</p>
        <pre id="metricsBlock">{{ metrics | tojson(indent=2) }}</pre>
      </div>

      <div class="card mt-3 p-3">
        <h5>Visualizations</h5>
        <canvas id="riskChart" width="400" height="200"></canvas>
        <div class="mt-2">
          <!-- Image will be set dynamically with cache-busting query param -->
          <img id="shapImg" alt="SHAP summary (if present)" style="max-width:100%; display:none">
          <div id="no-shap" class="text-muted small">
            SHAP summary not available yet. Generate explanations to see this visualization.
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
async function fetchExplainFiles() {
  try {
    const res = await fetch('/api/explain_files');
    if (!res.ok) return null;
    return await res.json();
  } catch (e) {
    console.error('Failed to fetch explain files', e);
    return null;
  }
}

let currentLatest = null;
async function updateShapImage() {
  const payload = await fetchExplainFiles();
  if (!payload || !payload.ok) return;
  const latest = payload.latest;
  if (!latest) {
    document.getElementById('shapImg').style.display = 'none';
    document.getElementById('no-shap').style.display = 'block';
    return;
  }
  // if filename or mtime changed, update image src with cache-busting timestamp
  if (!currentLatest || currentLatest.filename !== latest.filename || currentLatest.mtime !== latest.mtime) {
    currentLatest = latest;
    const img = document.getElementById('shapImg');
    img.src = `/reports/explain/${encodeURIComponent(latest.filename)}?t=${latest.mtime}`;
    img.style.display = 'block';
    document.getElementById('no-shap').style.display = 'none';
  }
}

// initial load
updateShapImage();
// poll every 30s
setInterval(updateShapImage, 30_000);

document.getElementById('singleForm').addEventListener('submit', async function (ev) {
  ev.preventDefault();
  const form = new FormData(this);
  const obj = {};
  form.forEach((v, k) => obj[k] = Number.isNaN(Number(v)) ? v : Number(v));
  const res = await fetch('/predict', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(obj)
  });
  const payload = await res.json();
  const el = document.getElementById('singleResult');
  el.style.display = 'block';
  if (payload.ok) {
    document.getElementById('resultText').innerText = `Prediction: ${payload.result.prediction} â€” Probability: ${payload.result.probability ?? 'n/a'}`;
  } else {
    document.getElementById('resultText').innerText = `Error: ${payload.error}`;
  }
});

// demo chart
const ctx = document.getElementById('riskChart').getContext('2d');
const riskChart = new Chart(ctx, {
  type: 'bar',
  data: {
    labels: ['Risk Score'],
    datasets: [{
      label: 'Probability (example)',
      data: [30],
      borderWidth: 1
    }]
  },
  options: {
    scales: { y: { beginAtZero: true, max: 100 } }
  }
});
</script>
</body>
</html>
